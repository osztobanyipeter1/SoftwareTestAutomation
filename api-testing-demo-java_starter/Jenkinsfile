pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                echo "====================================="
                echo "Checking out code from GitHub..."
                echo "====================================="

                checkout scm

                bat '''
                    cd api-testing-demo-java_starter
                    echo Repository: & git config --get remote.origin.url
                    echo Branch: & git rev-parse --abbrev-ref HEAD
                    echo Commit: & git rev-parse --short HEAD
                '''
            }
        }

        stage('Build') {
            steps {
                echo "====================================="
                echo "Building project with Gradle..."
                echo "====================================="

                bat '''
                    cd api-testing-demo-java_starter
                    echo Java version:
                    java -version

                    echo.
                    echo Building...
                    gradle clean build --refresh-dependencies -x test
                '''
            }
        }

        stage('API Tests (14 tests)') {
            steps {
                echo "====================================="
                echo "Running API Tests (14 tests)..."
                echo "====================================="

                bat '''
                    cd api-testing-demo-java_starter
                    gradle clean test -Ptag=api --no-build-cache
                '''
            }
        }

        stage('Allure Report') {
            steps {
                echo "====================================="
                echo "Generating Allure Report..."
                echo "====================================="

                bat '''
                    cd api-testing-demo-java_starter
                    if exist "build\\allure-results" (
                        echo Allure report found, generating...
                        allure generate build/allure-results --clean -o build/allure-report
                        echo Allure report generated successfully
                    ) else (
                        echo No allure results found
                    )
                '''
            }
        }
    }

    post {
        always {
            echo "====================================="
            echo "Archiving results..."
            echo "====================================="

            archiveArtifacts artifacts: '''
                api-testing-demo-java_starter/build/allure-results/**,
                ''',
            allowEmptyArchive: true

            junit testResults: 'api-testing-demo-java_starter/build/test-results/**/*.xml',
                 allowEmptyResults: true
        }

        success {
            echo "====================================="
            echo "BUILD SUCCESSFUL!"
            echo "====================================="
            echo "All API test passed"
        }

        failure {
            echo "====================================="
            echo "BUILD FAILED!"
            echo "====================================="
            echo "Check console output for details"
        }
    }
}
